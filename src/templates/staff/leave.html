{% extends "base.html" %}

{% block title %}Leave Management - StaffSync{% endblock %}

{% block content %}
<!-- Top Navigation -->
<nav class="navbar">
    <div class="container navbar-content">
        <a href="{{ url_for('staff_dashboard') }}" class="navbar-brand">
            <i class="fas fa-users"></i> StaffSync
        </a>
        <ul class="navbar-nav">
            <li><a href="{{ url_for('staff_dashboard') }}">Dashboard</a></li>
            <li><a href="{{ url_for('staff_profile') }}">Profile</a></li>
            <li><a href="{{ url_for('staff_leave') }}" class="active">Leave</a></li>
            <li><a href="{{ url_for('logout') }}">Logout</a></li>
        </ul>
        <div class="d-flex align-items-center gap-3">
            <span class="text-muted">Welcome, {{ session.username }}!</span>
        </div>
    </div>
</nav>

<!-- Main Content -->
<div class="container" style="padding: 2rem 1rem;">
    
    <!-- Leave Balance Card -->
    <div class="card mb-4">
        <div class="card-header">
            <h1 class="card-title">
                <i class="fas fa-calendar-times"></i> Leave Management
            </h1>
        </div>
        <div class="card-content">
            <div class="leave-balance-display">
                <div class="balance-item">
                    <div class="balance-number">{{ leave_balance }}</div>
                    <div class="balance-label">Days Remaining</div>
                </div>
                <div class="balance-item">
                    <div class="balance-number">{{ 20 - leave_balance }}</div>
                    <div class="balance-label">Days Used</div>
                </div>
                <div class="balance-item">
                    <div class="balance-number">20</div>
                    <div class="balance-label">Annual Allowance</div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Apply for Leave -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Apply for Leave</h3>
                </div>
                <div class="card-content">
                    <form method="POST" class="form" id="leaveForm">
                        <div class="form-group">
                            <label for="leave_type">Leave Type</label>
                            <select id="leave_type" name="leave_type" required>
                                <option value="">Select Leave Type</option>
                                <option value="annual">Annual Leave</option>
                                <option value="sick">Sick Leave</option>
                                <option value="emergency">Emergency Leave</option>
                                <option value="maternity">Maternity Leave</option>
                                <option value="paternity">Paternity Leave</option>
                                <option value="bereavement">Bereavement Leave</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="start_date">Start Date</label>
                            <input type="date" id="start_date" name="start_date" required>
                        </div>

                        <div class="form-group">
                            <label for="end_date">End Date</label>
                            <input type="date" id="end_date" name="end_date" required>
                        </div>

                        <div class="form-group">
                            <label for="days_preview">Total Days</label>
                            <div class="days-preview" id="days_preview">
                                <span class="text-muted">Select dates to calculate</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="reason">Reason for Leave</label>
                            <textarea id="reason" name="reason" rows="3" placeholder="Please provide a brief reason for your leave request..." required></textarea>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane"></i> Submit Leave Request
                            </button>
                            <button type="reset" class="btn btn-secondary">
                                <i class="fas fa-undo"></i> Clear Form
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Leave Guidelines -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Leave Guidelines</h3>
                </div>
                <div class="card-content">
                    <div class="guidelines">
                        <div class="guideline-item">
                            <h5><i class="fas fa-calendar-check text-success"></i> Annual Leave</h5>
                            <p>Standard vacation days. Requires advance notice of at least 2 weeks.</p>
                        </div>
                        
                        <div class="guideline-item">
                            <h5><i class="fas fa-user-injured text-warning"></i> Sick Leave</h5>
                            <p>For health-related absences. Medical certificate required for 3+ days.</p>
                        </div>
                        
                        <div class="guideline-item">
                            <h5><i class="fas fa-exclamation-triangle text-danger"></i> Emergency Leave</h5>
                            <p>For unexpected urgent situations. Contact HR immediately.</p>
                        </div>
                        
                        <div class="guideline-item">
                            <h5><i class="fas fa-baby text-info"></i> Maternity/Paternity</h5>
                            <p>Extended leave for new parents. Requires medical documentation.</p>
                        </div>
                    </div>
                    
                    <div class="contact-info mt-3">
                        <h6>Need Help?</h6>
                        <p class="text-muted mb-0">Contact HR at hr@staffsync.com or ext. 100</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leave History -->
    <div class="card mt-4">
        <div class="card-header">
            <h3 class="card-title">Leave History</h3>
        </div>
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>Leave Type</th>
                        <th>Duration</th>
                        <th>Days</th>
                        <th>Reason</th>
                        <th>Status</th>
                        <th>Applied Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for leave in leave_history %}
                    <tr>
                        <td>
                            <span class="leave-type-badge leave-type-{{ leave.leave_type }}">
                                {{ leave.leave_type|title }}
                            </span>
                        </td>
                        <td>
                            <div class="date-range">
                                <small class="text-muted">From:</small> {{ leave.start_date }}<br>
                                <small class="text-muted">To:</small> {{ leave.end_date }}
                            </div>
                        </td>
                        <td>
                            <span class="badge badge-info">{{ leave.days_count }} days</span>
                        </td>
                        <td>
                            <div class="reason-text">{{ leave.reason[:50] }}{% if leave.reason|length > 50 %}...{% endif %}</div>
                        </td>
                        <td>
                            <span class="badge badge-{{ 'warning' if leave.status == 'pending' else 'success' if leave.status == 'approved' else 'danger' }}">
                                {{ leave.status|title }}
                            </span>
                        </td>
                        <td>{{ leave.applied_date[:10] }}</td>
                        <td>
                            {% if leave.status == 'pending' %}
                                <button class="btn btn-sm btn-outline-danger" onclick="cancelLeave({{ leave.id }})">
                                    <i class="fas fa-times"></i>
                                </button>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">
                            <i class="fas fa-calendar fa-3x mb-3"></i>
                            <div>No leave applications found</div>
                            <small>Apply for your first leave using the form above</small>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
.leave-balance-display {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 2rem;
    padding: 1rem 0;
}

.balance-item {
    text-align: center;
}

.balance-number {
    font-size: 3rem;
    font-weight: 700;
    color: var(--primary-color);
    line-height: 1;
}

.balance-label {
    font-size: 0.875rem;
    color: var(--text-light);
    margin-top: 0.5rem;
}

.row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
}

.days-preview {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    padding: 0.75rem;
    border-radius: 0.375rem;
    font-weight: 600;
}

.guidelines {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.guideline-item h5 {
    margin: 0 0 0.5rem 0;
    font-size: 0.975rem;
}

.guideline-item p {
    margin: 0;
    font-size: 0.875rem;
    color: var(--text-light);
}

.leave-type-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.75rem;
    font-weight: 500;
    color: white;
}

.leave-type-annual {
    background: var(--primary-color);
}

.leave-type-sick {
    background: var(--warning-color);
}

.leave-type-emergency {
    background: var(--error-color);
}

.leave-type-maternity,
.leave-type-paternity {
    background: var(--info-color);
}

.leave-type-bereavement {
    background: #6c757d;
}

.date-range {
    font-size: 0.875rem;
    line-height: 1.4;
}

.reason-text {
    font-size: 0.875rem;
    color: var(--text-dark);
}

.badge {
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.75rem;
    font-weight: 500;
}

.badge-success {
    background: var(--success-color);
    color: white;
}

.badge-warning {
    background: var(--warning-color);
    color: white;
}

.badge-danger {
    background: var(--error-color);
    color: white;
}

.badge-info {
    background: var(--info-color);
    color: white;
}

.contact-info {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 0.375rem;
    border-left: 4px solid var(--primary-color);
}

.mt-3 {
    margin-top: 1rem;
}

.mt-4 {
    margin-top: 2rem;
}

.mb-0 {
    margin-bottom: 0;
}

.mb-3 {
    margin-bottom: 1rem;
}

.py-4 {
    padding: 2rem 0;
}

.text-center {
    text-align: center;
}

.text-muted {
    color: #6c757d;
}

@media (max-width: 768px) {
    .row {
        grid-template-columns: 1fr;
    }
    
    .leave-balance-display {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Calculate days between dates
function calculateDays() {
    const startDate = document.getElementById('start_date').value;
    const endDate = document.getElementById('end_date').value;
    const preview = document.getElementById('days_preview');
    
    if (startDate && endDate) {
        const start = new Date(startDate);
        const end = new Date(endDate);
        
        if (end >= start) {
            const timeDiff = end.getTime() - start.getTime();
            const dayDiff = Math.ceil(timeDiff / (1000 * 3600 * 24)) + 1;
            
            preview.innerHTML = `<span class="text-primary">${dayDiff} day(s)</span>`;
            
            // Check leave balance
            const currentBalance = {{ leave_balance }};
            if (dayDiff > currentBalance) {
                preview.innerHTML += ' <span class="text-danger">(Exceeds available balance)</span>';
            }
        } else {
            preview.innerHTML = '<span class="text-danger">End date must be after start date</span>';
        }
    } else {
        preview.innerHTML = '<span class="text-muted">Select dates to calculate</span>';
    }
}

// Set minimum dates
document.getElementById('start_date').min = new Date().toISOString().split('T')[0];
document.getElementById('end_date').min = new Date().toISOString().split('T')[0];

// Add event listeners
document.getElementById('start_date').addEventListener('change', function() {
    document.getElementById('end_date').min = this.value;
    calculateDays();
});

document.getElementById('end_date').addEventListener('change', calculateDays);

// Form validation
document.getElementById('leaveForm').addEventListener('submit', function(e) {
    const startDate = document.getElementById('start_date').value;
    const endDate = document.getElementById('end_date').value;
    const reason = document.getElementById('reason').value.trim();
    
    if (new Date(endDate) < new Date(startDate)) {
        e.preventDefault();
        showNotification('End date must be after start date', 'error');
        return false;
    }
    
    if (reason.length < 10) {
        e.preventDefault();
        showNotification('Please provide a detailed reason (at least 10 characters)', 'error');
        return false;
    }
    
    // Calculate days and check balance
    const start = new Date(startDate);
    const end = new Date(endDate);
    const dayDiff = Math.ceil((end.getTime() - start.getTime()) / (1000 * 3600 * 24)) + 1;
    
    if (dayDiff > {{ leave_balance }}) {
        e.preventDefault();
        showNotification('Leave days exceed your available balance', 'error');
        return false;
    }
});

// Cancel leave function
function cancelLeave(leaveId) {
    if (confirm('Are you sure you want to cancel this leave request?')) {
        showNotification('Leave cancellation feature coming soon!', 'info');
    }
}

// Clear form
document.querySelector('button[type="reset"]').addEventListener('click', function() {
    setTimeout(function() {
        document.getElementById('days_preview').innerHTML = '<span class="text-muted">Select dates to calculate</span>';
    }, 10);
});
</script>
{% endblock %}